---
title: "Oceanographic Profiles for Cariaco Chemoautotrophy Paper"
output: html_notebook
---

Load libraries
```{r}
library(oce)
library(ocedata)
library(tidyverse)
library(readxl)
library(gridGraphics)
library(gginnards)
library(cowplot)
```


## Load in and check CTD data. Do some QC of oxygen profiles

CAR212_2 (Leg 2 [Omics cruise] of Cariaco-212)
```{r}
## C212_2 cast 1

# Load in with oce package
C212_2_1 <- read.oce("CTD_data/C212_2_1.cnv")
# Trim the file to only the downcast
C212_2_1_dc <- ctdTrim(C212_2_1)
# Plot full profile
plot(C212_2_1_dc)
# Plot only oxygen
plotProfile(C212_2_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_2_1_dc[["oxygen5"]] <- C212_2_1_dc[["oxygen5"]]-0.3 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C212_2_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C212_2_1_dc, ytype = "depth", "oxygen5") 

## C212_2 cast 2

# Load in with oce package
C212_2_2 <- read.oce("CTD_data/C212_2_2.cnv")
# Trim the file to only the downcast
C212_2_2_dc <- ctdTrim(C212_2_2)
# Plot full profile
plot(C212_2_2_dc)
# Plot only oxygen
plotProfile(C212_2_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_2_2_dc[["oxygen5"]] <- C212_2_2_dc[["oxygen5"]]-0.34
# Plot again
plotProfile(C212_2_2_dc, ytype = "depth", "oxygen5") 

## C212_2 cast 3

# Load in with oce package
C212_2_3 <- read.oce("CTD_data/C212_2_3.cnv")
# Trim the file to only the downcast
C212_2_3_dc <- ctdTrim(C212_2_3)
# Plot full profile
plot(C212_2_3_dc)
# Plot only oxygen
plotProfile(C212_2_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C212_2_3_dc[["oxygen5"]] <- C212_2_3_dc[["oxygen5"]]-0.31
# Plot again
plotProfile(C212_2_3_dc, ytype = "depth", "oxygen5") 

## C212_2 cast 4

# Load in with oce package
C212_2_4 <- read.oce("CTD_data/C212_2_4.cnv")
# Trim the file to only the downcast
C212_2_4_dc <- ctdTrim(C212_2_4)
# Plot full profile
plot(C212_2_4_dc)
# Plot only oxygen
plotProfile(C212_2_4_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C212_2_4_dc[["oxygen5"]] <- C212_2_4_dc[["oxygen5"]]-0.31
# Plot again
plotProfile(C212_2_4_dc, ytype = "depth", "oxygen5") 

# Plot  oxygen data from all casts on same plot
plotProfile(C212_2_1_dc, ytype = "depth", "oxygen5")
lines(C212_2_2_dc[["oxygen5"]], C212_2_2_dc[["depth"]], col = "red")
lines(C212_2_3_dc[["oxygen5"]], C212_2_3_dc[["depth"]], col = "blue")
lines(C212_2_4_dc[["oxygen5"]], C212_2_4_dc[["depth"]], col = "green")
```



CAR212_3 (Leg 3 [SBU cruise] of Cariaco-212)
```{r}
## C212_3 cast 1

# Load in with oce package
C212_3_1 <- read.oce("CTD_data/C212_3_1.cnv")
# Trim the file to only the downcast
C212_3_1_dc <- ctdTrim(C212_3_1)
# Plot full profile
plot(C212_3_1_dc)
# Plot only oxygen
plotProfile(C212_3_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_3_1_dc[["oxygen5"]] <- C212_3_1_dc[["oxygen5"]]-0.3 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C212_3_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C212_3_1_dc, ytype = "depth", "oxygen5") 

## C212_3 cast 2

# Load in with oce package
C212_3_2 <- read.oce("CTD_data/C212_3_2.cnv")
# Trim the file to only the downcast
C212_3_2_dc <- ctdTrim(C212_3_2)
# Plot full profile
plot(C212_3_2_dc)
# Plot only oxygen
plotProfile(C212_3_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_3_2_dc[["oxygen5"]] <- C212_3_2_dc[["oxygen5"]]-0.31
# Plot again
plotProfile(C212_3_2_dc, ytype = "depth", "oxygen5") 

## C212_3 cast 3

# Load in with oce package
C212_3_3 <- read.oce("CTD_data/C212_3_3.cnv")
# Trim the file to only the downcast
C212_3_3_dc <- ctdTrim(C212_3_3)
# Plot full profile
plot(C212_3_3_dc)
# Plot only oxygen
plotProfile(C212_3_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C212_3_3_dc[["oxygen5"]] <- C212_3_3_dc[["oxygen5"]]-0.33
# Plot again
plotProfile(C212_3_3_dc, ytype = "depth", "oxygen5") 


# Plot  oxygen data from all casts on same plot
plotProfile(C212_3_3_dc, ytype = "depth", "oxygen5", col = "blue")
lines(C212_3_2_dc[["oxygen5"]], C212_3_2_dc[["depth"]], col = "red")
lines(C212_3_1_dc[["oxygen5"]], C212_3_1_dc[["depth"]], col = "black")
```




CAR216_2 (Leg 2 [Omics cruise] of Cariaco-216)
```{r}
## C216_2 cast 1

# Load in with oce package
C216_2_1 <- read.oce("CTD_data/C216_2_1.cnv")
# Trim the file to only the downcast
C216_2_1_dc <- ctdTrim(C216_2_1)
# Plot full profile
plot(C216_2_1_dc)
# Plot only oxygen
plotProfile(C216_2_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_2_1_dc[["oxygen5"]] <- C216_2_1_dc[["oxygen5"]]-2.28 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C216_2_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C216_2_1_dc, ytype = "depth", "oxygen5") 

## C216_2 cast 2

# Load in with oce package
C216_2_2 <- read.oce("CTD_data/C216_2_2.cnv")
# Trim the file to only the downcast
C216_2_2_dc <- ctdTrim(C216_2_2)
# Plot full profile
plot(C216_2_2_dc)
# Plot only oxygen
plotProfile(C216_2_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_2_2_dc[["oxygen5"]] <- C216_2_2_dc[["oxygen5"]]-2.3
# Plot again
plotProfile(C216_2_2_dc, ytype = "depth", "oxygen5") 

## C216_2 cast 3

# Load in with oce package
C216_2_3 <- read.oce("CTD_data/C216_2_3.cnv")
# Trim the file to only the downcast
C216_2_3_dc <- ctdTrim(C216_2_3)
# Plot full profile
plot(C216_2_3_dc)
# Plot only oxygen
plotProfile(C216_2_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C216_2_3_dc[["oxygen5"]] <- C216_2_3_dc[["oxygen5"]]-2.29
# Plot again
plotProfile(C216_2_3_dc, ytype = "depth", "oxygen5") 

## C216_2 cast 4

# Load in with oce package
C216_2_4 <- read.oce("CTD_data/C216_2_4.cnv")
# Trim the file to only the downcast
C216_2_4_dc <- ctdTrim(C216_2_4)
# Plot full profile
plot(C216_2_4_dc)
# Plot only oxygen
plotProfile(C216_2_4_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C216_2_4_dc[["oxygen5"]] <- C216_2_4_dc[["oxygen5"]]-2.29
# Plot again
plotProfile(C216_2_4_dc, ytype = "depth", "oxygen5") 

# Plot  oxygen data from all casts on same plot
plotProfile(C216_2_1_dc, ytype = "depth", "oxygen5")
lines(C216_2_2_dc[["oxygen5"]], C216_2_2_dc[["depth"]], col = "red")
lines(C216_2_3_dc[["oxygen5"]], C216_2_3_dc[["depth"]], col = "blue")
lines(C216_2_4_dc[["oxygen5"]], C216_2_4_dc[["depth"]], col = "green")
```



CAR216_3 (Leg 3 [SBU cruise] of Cariaco-216)
```{r}
## C216_3 cast 1
# Note- the transmissometer data (BAT) for this cruise is bad Something happened to sensor

# Load in with oce package
C216_3_1 <- read.oce("CTD_data/C216_3_1.cnv")
# Trim the file to only the downcast
C216_3_1_dc <- ctdTrim(C216_3_1)
# Plot full profile
plot(C216_3_1_dc)
# Plot only oxygen
plotProfile(C216_3_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_3_1_dc[["oxygen5"]] <- C216_3_1_dc[["oxygen5"]]-2.20 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C216_3_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C216_3_1_dc, ytype = "depth", "oxygen5") 

## C216_3 cast 2

# Load in with oce package
C216_3_2 <- read.oce("CTD_data/C216_3_2.cnv")
# Trim the file to only the downcast
C216_3_2_dc <- ctdTrim(C216_3_2)
# Plot full profile
plot(C216_3_2_dc)
# Plot only oxygen
plotProfile(C216_3_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_3_2_dc[["oxygen5"]] <- C216_3_2_dc[["oxygen5"]]-2.34
# Plot again
plotProfile(C216_3_2_dc, ytype = "depth", "oxygen5") 

## C216_3 cast 3

# Load in with oce package
C216_3_3 <- read.oce("CTD_data/C216_3_3.cnv")
# Trim the file to only the downcast
C216_3_3_dc <- ctdTrim(C216_3_3)
# Plot full profile
plot(C216_3_3_dc)
# Plot only oxygen
plotProfile(C216_3_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C216_3_3_dc[["oxygen5"]] <- C216_3_3_dc[["oxygen5"]]-2.36
# Plot again
plotProfile(C216_3_3_dc, ytype = "depth", "oxygen5") 


# Plot  oxygen data from all casts on same plot
plotProfile(C216_3_3_dc, ytype = "depth", "oxygen5", col = "blue")
lines(C216_3_2_dc[["oxygen5"]], C216_3_2_dc[["depth"]], col = "red")
lines(C216_3_1_dc[["oxygen5"]], C216_3_1_dc[["depth"]], col = "black")
```



CAR224_2 (Leg 2 [SBU cruise] of Cariaco-224)
```{r}
## C224_2 cast 1

# Load in with oce package
C224_1 <- read.oce("CTD_data/C224_1.cnv")
# Trim the file to only the downcast
C224_1_dc <- ctdTrim(C224_1)
# Plot full profile
plot(C224_1_dc)
# Plot only oxygen
plotProfile(C224_1_dc, ytype = "depth", "oxygen6")
# Correct DO by sensor offset
C224_1_dc[["oxygen6"]] <- C224_1_dc[["oxygen6"]]-3.53 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C224_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C224_1_dc, ytype = "depth", "oxygen6") 

## C224 cast 2

# Load in with oce package
C224_2 <- read.oce("CTD_data/C224_2.cnv")
# Trim the file to only the downcast
C224_2_dc <- ctdTrim(C224_2)
# Plot full profile
plot(C224_2_dc)
# Plot only oxygen
plotProfile(C224_2_dc, ytype = "depth", "oxygen6")
# Correct DO by sensor offset
C224_2_dc[["oxygen6"]] <- C224_2_dc[["oxygen6"]]-3.53
# Plot again
plotProfile(C224_2_dc, ytype = "depth", "oxygen6") 

## C224 cast 3

# Load in with oce package
C224_3 <- read.oce("CTD_data/C224_3.cnv")
# Trim the file to only the downcast
C224_3_dc <- ctdTrim(C224_3)
# Plot full profile
plot(C224_3_dc)
# Plot only oxygen
plotProfile(C224_3_dc, ytype = "depth", "oxygen6") 
# Correct DO by sensor offset
C224_3_dc[["oxygen6"]] <- C224_3_dc[["oxygen6"]]-3.82
# Plot again
plotProfile(C224_3_dc, ytype = "depth", "oxygen6") 


# Plot  oxygen data from all casts on same plot
plotProfile(C224_3_dc, ytype = "depth", "oxygen6", col = "blue")
lines(C224_1_dc[["oxygen6"]], C224_1_dc[["depth"]], col = "black")
lines(C224_2_dc[["oxygen6"]], C224_2_dc[["depth"]], col = "red")
```

## Convert ctd data type to tibbles type
Put in depth, DO, BAT from downcast for each cast/cruise combo
```{r}
# CAR212
# CAR212, leg 2, casts 1-4
C212_2_1_ctd <- tibble("depth" = C212_2_1_dc[["depth"]], "oxygen" = C212_2_1_dc[["oxygen5"]], "BAT" =
                         C212_2_1_dc[["beamAttenuation"]])

C212_2_2_ctd <- tibble("depth" = C212_2_2_dc[["depth"]], "oxygen" = C212_2_2_dc[["oxygen5"]], "BAT" =
                         C212_2_2_dc[["beamAttenuation"]])

C212_2_3_ctd <- tibble("depth" = C212_2_3_dc[["depth"]], "oxygen" = C212_2_3_dc[["oxygen5"]], "BAT" =
                         C212_2_3_dc[["beamAttenuation"]])

C212_2_4_ctd <- tibble("depth" = C212_2_4_dc[["depth"]], "oxygen" = C212_2_4_dc[["oxygen5"]], "BAT" =
                         C212_2_4_dc[["beamAttenuation"]])


#CAR212, leg 3, casts 1-3
C212_3_1_ctd <- tibble("depth" = C212_3_1_dc[["depth"]], "oxygen" = C212_3_1_dc[["oxygen5"]], "BAT" =
                         C212_3_1_dc[["beamAttenuation"]])

C212_3_2_ctd <- tibble("depth" = C212_3_2_dc[["depth"]], "oxygen" = C212_3_2_dc[["oxygen5"]], "BAT" =
                         C212_3_2_dc[["beamAttenuation"]])

C212_3_3_ctd <- tibble("depth" = C212_3_3_dc[["depth"]], "oxygen" = C212_3_3_dc[["oxygen5"]], "BAT" =
                         C212_3_3_dc[["beamAttenuation"]])

# CAR216
# CAR216, leg 2, casts 1-4
C216_2_1_ctd <- tibble("depth" = C216_2_1_dc[["depth"]], "oxygen" = C216_2_1_dc[["oxygen5"]], "BAT" =
                         C216_2_1_dc[["beamAttenuation"]])

C216_2_2_ctd <- tibble("depth" = C216_2_2_dc[["depth"]], "oxygen" = C216_2_2_dc[["oxygen5"]], "BAT" =
                         C216_2_2_dc[["beamAttenuation"]])

C216_2_3_ctd <- tibble("depth" = C216_2_3_dc[["depth"]], "oxygen" = C216_2_3_dc[["oxygen5"]], "BAT" =
                         C216_2_3_dc[["beamAttenuation"]])

C216_2_4_ctd <- tibble("depth" = C216_2_4_dc[["depth"]], "oxygen" = C216_2_4_dc[["oxygen5"]], "BAT" =
                         C216_2_4_dc[["beamAttenuation"]])


# CAR216, leg 3, casts 1-3
C216_3_1_ctd <- tibble("depth" = C216_3_1_dc[["depth"]], "oxygen" = C216_3_1_dc[["oxygen5"]], "BAT" =
                         C216_3_1_dc[["beamAttenuation"]])

C216_3_2_ctd <- tibble("depth" = C216_3_2_dc[["depth"]], "oxygen" = C216_3_2_dc[["oxygen5"]], "BAT" =
                         C216_3_2_dc[["beamAttenuation"]])

C216_3_3_ctd <- tibble("depth" = C216_3_3_dc[["depth"]], "oxygen" = C216_3_3_dc[["oxygen5"]], "BAT" =
                         C216_3_3_dc[["beamAttenuation"]])


#CAR224
# CAR224, [only one leg], casts 1-3
C224_1_ctd <- tibble("depth" = C224_1_dc[["depth"]], "oxygen" = C224_1_dc[["oxygen6"]], "BAT" =
                       C224_1_dc[["beamAttenuation"]])

C224_2_ctd <- tibble("depth" = C224_2_dc[["depth"]], "oxygen" = C224_2_dc[["oxygen6"]], "BAT" =
                       C224_2_dc[["beamAttenuation"]])

C224_3_ctd <- tibble("depth" = C224_3_dc[["depth"]], "oxygen" = C224_3_dc[["oxygen6"]], "BAT" = 
                     C224_3_dc[["beamAttenuation"]])


```


## Import grab sample data

```{r}
C212_2_grab <- read_csv("GrabSample_data/C212_2.csv")
C212_3_grab <- read_csv("GrabSample_data/C212_3.csv")

C216_2_grab <- read_csv("GrabSample_data/C216_2.csv")
C216_3_grab <- read_csv("GrabSample_data/C216_3.csv")

C224_grab <- read_csv("GrabSample_data/C224.csv")

```

## Combine CTD and Grab Sample Data for each Cruise into one tibble
For each cruise I have to make a decision on which CTD cast to use for plotting. Check oxygen profiles (above) for major features and also notes on which samples came from which casts.

**C212_2**: DNA for metagnome/ iTags came from cast 3 so use CTD data from cast 3, C212_2_3

**C212_3**: Use cast 1, which targetted samples from the chemoautotrophy zone (depths 260-320m). CTD goes down to 399m

**C216_2**: In virus paper, we used CTD data from C216_2_2 and C216_2_4 because those are where DNA/ VLP samples came from. Both casts have the full profile to 900m and both collected at 148, 200, 237, 247, 267, and 900m. Looking at DO profiles (above) they are very similar so it doesn't matter too much (unlike for C212_2). So plot C216_2_2 for now.

**C216_3**: Use cast 1, which targetted samples from the chemoautotrophy zone (depths 250-310m). CTD goes down to 399m

**C224**: Use cast 1, which targetted samples from the chemoautotrophy zone (depths 277-329m). CTD goes down to 397m


```{r}
C212_2 <- full_join(C212_2_3_ctd,C212_2_grab, by = "depth")
C212_3 <- full_join(C212_3_1_ctd,C212_3_grab, by = "depth")

C216_2 <- full_join(C216_2_2_ctd,C216_2_grab, by = "depth")
C216_3 <- full_join(C216_3_1_ctd,C216_3_grab, by = "depth")

C224 <- full_join(C224_1_ctd,C224_grab, by = "depth")

```


## Plots

For making multiple panels, use cowplot?: https://stackoverflow.com/questions/1249548/side-by-side-plots-with-ggplot2 

```{r}

# Make filled area plot of DO + H2S with geom_area

# C212_2
C212_2_panel1 <- ggplot(C212_2) +
  geom_line(aes(y = BAT, x = depth), color="black", size=1.5, na.rm = T) +
  geom_area(aes(y = oxygen/100, x = depth), fill = "cyan", alpha = 0.4) +
  scale_y_continuous(name = expression(BAT~"["~m^{-1}~"]"),sec.axis = sec_axis(trans=~.*100, name="oxygen [µM]"), expand = c(0, 0)) +
  coord_flip() +
  scale_x_reverse(limits = c(400, 100), expand = c(0, 0)) +
  theme_bw()
move_layers(C212_2_panel1, "GeomLine", position = "top") # uses function from gginnards to move geom_line on top of geom_area


C212_2_panel2 <- ggplot(C212_2) +
  geom_line(aes(y = Micro_Abund_DAPI, x = depth, group=1), color="black", size=1, na.rm = T, lty = 2) +
  geom_point(aes(y = Micro_Abund_DAPI, x = depth), shape = 21, colour = "black", fill = "white", size = 2) +
  geom_area(aes(y = oxygen/10, x = depth), fill = "cyan", alpha = 0.4) +
  scale_y_continuous(name = expression(Microbial~Abund~"["~x10^{8}~L^{-1}~"]"),sec.axis = sec_axis(trans=~.*10, name="oxygen [µM]"), expand = c(0, 0)) +
  coord_flip() +
  scale_x_reverse(limits = c(400, 100), expand = c(0, 0)) +
  theme_bw()
move_layers(C212_2_panel2, "GeomPath", position = "top") # uses function from gginnards to move geom_line on top of geom_area





```

