---
title: "Oceanographic Profiles for Cariaco Chemoautotrophy Paper"
output: html_notebook
---

Load libraries
```{r}
library(oce)
library(ocedata)
library(tidyverse)
library(gginnards)
library(cowplot)
library(egg)
```


## Load in and check CTD data. Do some QC of oxygen profiles

CAR212_2 (Leg 2 [Omics cruise] of Cariaco-212)
```{r}
## C212_2 cast 1

# Load in with oce package
C212_2_1 <- read.oce("CTD_data/C212_2_1.cnv")
# Trim the file to only the downcast
C212_2_1_dc <- ctdTrim(C212_2_1)
# Plot full profile
plot(C212_2_1_dc)
# Plot only oxygen
plotProfile(C212_2_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_2_1_dc[["oxygen5"]] <- C212_2_1_dc[["oxygen5"]]-0.3 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C212_2_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C212_2_1_dc, ytype = "depth", "oxygen5") 

## C212_2 cast 2

# Load in with oce package
C212_2_2 <- read.oce("CTD_data/C212_2_2.cnv")
# Trim the file to only the downcast
C212_2_2_dc <- ctdTrim(C212_2_2)
# Plot full profile
plot(C212_2_2_dc)
# Plot only oxygen
plotProfile(C212_2_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_2_2_dc[["oxygen5"]] <- C212_2_2_dc[["oxygen5"]]-0.34
# Plot again
plotProfile(C212_2_2_dc, ytype = "depth", "oxygen5") 

## C212_2 cast 3

# Load in with oce package
C212_2_3 <- read.oce("CTD_data/C212_2_3.cnv")
# Trim the file to only the downcast
C212_2_3_dc <- ctdTrim(C212_2_3)
# Plot full profile
plot(C212_2_3_dc)
# Plot only oxygen
plotProfile(C212_2_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C212_2_3_dc[["oxygen5"]] <- C212_2_3_dc[["oxygen5"]]-0.31
# Plot again
plotProfile(C212_2_3_dc, ytype = "depth", "oxygen5") 

## C212_2 cast 4

# Load in with oce package
C212_2_4 <- read.oce("CTD_data/C212_2_4.cnv")
# Trim the file to only the downcast
C212_2_4_dc <- ctdTrim(C212_2_4)
# Plot full profile
plot(C212_2_4_dc)
# Plot only oxygen
plotProfile(C212_2_4_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C212_2_4_dc[["oxygen5"]] <- C212_2_4_dc[["oxygen5"]]-0.31
# Plot again
plotProfile(C212_2_4_dc, ytype = "depth", "oxygen5") 

# Plot  oxygen data from all casts on same plot
plotProfile(C212_2_1_dc, ytype = "depth", "oxygen5")
lines(C212_2_2_dc[["oxygen5"]], C212_2_2_dc[["depth"]], col = "red")
lines(C212_2_3_dc[["oxygen5"]], C212_2_3_dc[["depth"]], col = "blue")
lines(C212_2_4_dc[["oxygen5"]], C212_2_4_dc[["depth"]], col = "green")
```



CAR212_3 (Leg 3 [SBU cruise] of Cariaco-212)
```{r}
## C212_3 cast 1

# Load in with oce package
C212_3_1 <- read.oce("CTD_data/C212_3_1.cnv")
# Trim the file to only the downcast
C212_3_1_dc <- ctdTrim(C212_3_1)
# Plot full profile
plot(C212_3_1_dc)
# Plot only oxygen
plotProfile(C212_3_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_3_1_dc[["oxygen5"]] <- C212_3_1_dc[["oxygen5"]]-0.3 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C212_3_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C212_3_1_dc, ytype = "depth", "oxygen5") 

## C212_3 cast 2

# Load in with oce package
C212_3_2 <- read.oce("CTD_data/C212_3_2.cnv")
# Trim the file to only the downcast
C212_3_2_dc <- ctdTrim(C212_3_2)
# Plot full profile
plot(C212_3_2_dc)
# Plot only oxygen
plotProfile(C212_3_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C212_3_2_dc[["oxygen5"]] <- C212_3_2_dc[["oxygen5"]]-0.31
# Plot again
plotProfile(C212_3_2_dc, ytype = "depth", "oxygen5") 

## C212_3 cast 3

# Load in with oce package
C212_3_3 <- read.oce("CTD_data/C212_3_3.cnv")
# Trim the file to only the downcast
C212_3_3_dc <- ctdTrim(C212_3_3)
# Plot full profile
plot(C212_3_3_dc)
# Plot only oxygen
plotProfile(C212_3_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C212_3_3_dc[["oxygen5"]] <- C212_3_3_dc[["oxygen5"]]-0.33
# Plot again
plotProfile(C212_3_3_dc, ytype = "depth", "oxygen5") 


# Plot  oxygen data from all casts on same plot
plotProfile(C212_3_3_dc, ytype = "depth", "oxygen5", col = "blue")
lines(C212_3_2_dc[["oxygen5"]], C212_3_2_dc[["depth"]], col = "red")
lines(C212_3_1_dc[["oxygen5"]], C212_3_1_dc[["depth"]], col = "black")
```




CAR216_2 (Leg 2 [Omics cruise] of Cariaco-216)
```{r}
## C216_2 cast 1

# Load in with oce package
C216_2_1 <- read.oce("CTD_data/C216_2_1.cnv")
# Trim the file to only the downcast
C216_2_1_dc <- ctdTrim(C216_2_1)
# Plot full profile
plot(C216_2_1_dc)
# Plot only oxygen
plotProfile(C216_2_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_2_1_dc[["oxygen5"]] <- C216_2_1_dc[["oxygen5"]]-2.28 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C216_2_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C216_2_1_dc, ytype = "depth", "oxygen5") 

## C216_2 cast 2

# Load in with oce package
C216_2_2 <- read.oce("CTD_data/C216_2_2.cnv")
# Trim the file to only the downcast
C216_2_2_dc <- ctdTrim(C216_2_2)
# Plot full profile
plot(C216_2_2_dc)
# Plot only oxygen
plotProfile(C216_2_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_2_2_dc[["oxygen5"]] <- C216_2_2_dc[["oxygen5"]]-2.3
# Plot again
plotProfile(C216_2_2_dc, ytype = "depth", "oxygen5") 

## C216_2 cast 3

# Load in with oce package
C216_2_3 <- read.oce("CTD_data/C216_2_3.cnv")
# Trim the file to only the downcast
C216_2_3_dc <- ctdTrim(C216_2_3)
# Plot full profile
plot(C216_2_3_dc)
# Plot only oxygen
plotProfile(C216_2_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C216_2_3_dc[["oxygen5"]] <- C216_2_3_dc[["oxygen5"]]-2.29
# Plot again
plotProfile(C216_2_3_dc, ytype = "depth", "oxygen5") 

## C216_2 cast 4

# Load in with oce package
C216_2_4 <- read.oce("CTD_data/C216_2_4.cnv")
# Trim the file to only the downcast
C216_2_4_dc <- ctdTrim(C216_2_4)
# Plot full profile
plot(C216_2_4_dc)
# Plot only oxygen
plotProfile(C216_2_4_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C216_2_4_dc[["oxygen5"]] <- C216_2_4_dc[["oxygen5"]]-2.29
# Plot again
plotProfile(C216_2_4_dc, ytype = "depth", "oxygen5") 

# Plot  oxygen data from all casts on same plot
plotProfile(C216_2_1_dc, ytype = "depth", "oxygen5")
lines(C216_2_2_dc[["oxygen5"]], C216_2_2_dc[["depth"]], col = "red")
lines(C216_2_3_dc[["oxygen5"]], C216_2_3_dc[["depth"]], col = "blue")
lines(C216_2_4_dc[["oxygen5"]], C216_2_4_dc[["depth"]], col = "green")
```



CAR216_3 (Leg 3 [SBU cruise] of Cariaco-216)
```{r}
## C216_3 cast 1
# Note- the transmissometer data (BAT) for this cruise is bad Something happened to sensor

# Load in with oce package
C216_3_1 <- read.oce("CTD_data/C216_3_1.cnv")
# Trim the file to only the downcast
C216_3_1_dc <- ctdTrim(C216_3_1)
# Plot full profile
plot(C216_3_1_dc)
# Plot only oxygen
plotProfile(C216_3_1_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_3_1_dc[["oxygen5"]] <- C216_3_1_dc[["oxygen5"]]-2.20 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C216_3_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C216_3_1_dc, ytype = "depth", "oxygen5") 

## C216_3 cast 2

# Load in with oce package
C216_3_2 <- read.oce("CTD_data/C216_3_2.cnv")
# Trim the file to only the downcast
C216_3_2_dc <- ctdTrim(C216_3_2)
# Plot full profile
plot(C216_3_2_dc)
# Plot only oxygen
plotProfile(C216_3_2_dc, ytype = "depth", "oxygen5")
# Correct DO by sensor offset
C216_3_2_dc[["oxygen5"]] <- C216_3_2_dc[["oxygen5"]]-2.34
# Plot again
plotProfile(C216_3_2_dc, ytype = "depth", "oxygen5") 

## C216_3 cast 3

# Load in with oce package
C216_3_3 <- read.oce("CTD_data/C216_3_3.cnv")
# Trim the file to only the downcast
C216_3_3_dc <- ctdTrim(C216_3_3)
# Plot full profile
plot(C216_3_3_dc)
# Plot only oxygen
plotProfile(C216_3_3_dc, ytype = "depth", "oxygen5") 
# Correct DO by sensor offset
C216_3_3_dc[["oxygen5"]] <- C216_3_3_dc[["oxygen5"]]-2.36
# Plot again
plotProfile(C216_3_3_dc, ytype = "depth", "oxygen5") 


# Plot  oxygen data from all casts on same plot
plotProfile(C216_3_3_dc, ytype = "depth", "oxygen5", col = "blue")
lines(C216_3_2_dc[["oxygen5"]], C216_3_2_dc[["depth"]], col = "red")
lines(C216_3_1_dc[["oxygen5"]], C216_3_1_dc[["depth"]], col = "black")
```



CAR224_2 (Leg 2 [SBU cruise] of Cariaco-224)
```{r}
## C224_2 cast 1

# Load in with oce package
C224_1 <- read.oce("CTD_data/C224_1.cnv")
# Trim the file to only the downcast
C224_1_dc <- ctdTrim(C224_1)
# Plot full profile
plot(C224_1_dc)
# Plot only oxygen
plotProfile(C224_1_dc, ytype = "depth", "oxygen6")
# Correct DO by sensor offset
C224_1_dc[["oxygen6"]] <- C224_1_dc[["oxygen6"]]-3.53 #I had previously determined these offsets by taking the average DO concentration below the chemocline (where conditions are sulfidic and DO is confidently zero). Check "C224_ctd_cor.xlsx" for details.
# Plot again
plotProfile(C224_1_dc, ytype = "depth", "oxygen6") 

## C224 cast 2

# Load in with oce package
C224_2 <- read.oce("CTD_data/C224_2.cnv")
# Trim the file to only the downcast
C224_2_dc <- ctdTrim(C224_2)
# Plot full profile
plot(C224_2_dc)
# Plot only oxygen
plotProfile(C224_2_dc, ytype = "depth", "oxygen6")
# Correct DO by sensor offset
C224_2_dc[["oxygen6"]] <- C224_2_dc[["oxygen6"]]-3.53
# Plot again
plotProfile(C224_2_dc, ytype = "depth", "oxygen6") 

## C224 cast 3

# Load in with oce package
C224_3 <- read.oce("CTD_data/C224_3.cnv")
# Trim the file to only the downcast
C224_3_dc <- ctdTrim(C224_3)
# Plot full profile
plot(C224_3_dc)
# Plot only oxygen
plotProfile(C224_3_dc, ytype = "depth", "oxygen6") 
# Correct DO by sensor offset
C224_3_dc[["oxygen6"]] <- C224_3_dc[["oxygen6"]]-3.82
# Plot again
plotProfile(C224_3_dc, ytype = "depth", "oxygen6") 


# Plot  oxygen data from all casts on same plot
plotProfile(C224_3_dc, ytype = "depth", "oxygen6", col = "blue")
lines(C224_1_dc[["oxygen6"]], C224_1_dc[["depth"]], col = "black")
lines(C224_2_dc[["oxygen6"]], C224_2_dc[["depth"]], col = "red")
```

## Convert ctd data type to tibbles 
Put in depth, DO, BAT from downcast for each cast/cruise combo
```{r}
# CAR212
# CAR212, leg 2, casts 1-4
C212_2_1_ctd <- tibble("depth" = C212_2_1_dc[["depth"]], "oxygen" = C212_2_1_dc[["oxygen5"]], "BAT" =
                         C212_2_1_dc[["beamAttenuation"]])

C212_2_2_ctd <- tibble("depth" = C212_2_2_dc[["depth"]], "oxygen" = C212_2_2_dc[["oxygen5"]], "BAT" =
                         C212_2_2_dc[["beamAttenuation"]])

C212_2_3_ctd <- tibble("depth" = C212_2_3_dc[["depth"]], "oxygen" = C212_2_3_dc[["oxygen5"]], "BAT" =
                         C212_2_3_dc[["beamAttenuation"]])

C212_2_4_ctd <- tibble("depth" = C212_2_4_dc[["depth"]], "oxygen" = C212_2_4_dc[["oxygen5"]], "BAT" =
                         C212_2_4_dc[["beamAttenuation"]])


#CAR212, leg 3, casts 1-3
C212_3_1_ctd <- tibble("depth" = C212_3_1_dc[["depth"]], "oxygen" = C212_3_1_dc[["oxygen5"]], "BAT" =
                         C212_3_1_dc[["beamAttenuation"]])

C212_3_2_ctd <- tibble("depth" = C212_3_2_dc[["depth"]], "oxygen" = C212_3_2_dc[["oxygen5"]], "BAT" =
                         C212_3_2_dc[["beamAttenuation"]])

C212_3_3_ctd <- tibble("depth" = C212_3_3_dc[["depth"]], "oxygen" = C212_3_3_dc[["oxygen5"]], "BAT" =
                         C212_3_3_dc[["beamAttenuation"]])

# CAR216
# CAR216, leg 2, casts 1-4
C216_2_1_ctd <- tibble("depth" = C216_2_1_dc[["depth"]], "oxygen" = C216_2_1_dc[["oxygen5"]], "BAT" =
                         C216_2_1_dc[["beamAttenuation"]])

C216_2_2_ctd <- tibble("depth" = C216_2_2_dc[["depth"]], "oxygen" = C216_2_2_dc[["oxygen5"]], "BAT" =
                         C216_2_2_dc[["beamAttenuation"]])

C216_2_3_ctd <- tibble("depth" = C216_2_3_dc[["depth"]], "oxygen" = C216_2_3_dc[["oxygen5"]], "BAT" =
                         C216_2_3_dc[["beamAttenuation"]])

C216_2_4_ctd <- tibble("depth" = C216_2_4_dc[["depth"]], "oxygen" = C216_2_4_dc[["oxygen5"]], "BAT" =
                         C216_2_4_dc[["beamAttenuation"]])


# CAR216, leg 3, casts 1-3
C216_3_1_ctd <- tibble("depth" = C216_3_1_dc[["depth"]], "oxygen" = C216_3_1_dc[["oxygen5"]], "BAT" =
                         C216_3_1_dc[["beamAttenuation"]])

C216_3_2_ctd <- tibble("depth" = C216_3_2_dc[["depth"]], "oxygen" = C216_3_2_dc[["oxygen5"]], "BAT" =
                         C216_3_2_dc[["beamAttenuation"]])

C216_3_3_ctd <- tibble("depth" = C216_3_3_dc[["depth"]], "oxygen" = C216_3_3_dc[["oxygen5"]], "BAT" =
                         C216_3_3_dc[["beamAttenuation"]])


#CAR224
# CAR224, [only one leg], casts 1-3
C224_1_ctd <- tibble("depth" = C224_1_dc[["depth"]], "oxygen" = C224_1_dc[["oxygen6"]], "BAT" =
                       C224_1_dc[["beamAttenuation"]])

C224_2_ctd <- tibble("depth" = C224_2_dc[["depth"]], "oxygen" = C224_2_dc[["oxygen6"]], "BAT" =
                       C224_2_dc[["beamAttenuation"]])

C224_3_ctd <- tibble("depth" = C224_3_dc[["depth"]], "oxygen" = C224_3_dc[["oxygen6"]], "BAT" = 
                     C224_3_dc[["beamAttenuation"]])


```


## Import grab sample data

```{r}
C212_2_grab <- read_csv("GrabSample_data/C212_2.csv")
C212_3_grab <- read_csv("GrabSample_data/C212_3.csv")

C216_2_grab <- read_csv("GrabSample_data/C216_2.csv")
C216_3_grab <- read_csv("GrabSample_data/C216_3.csv")

C224_grab <- read_csv("GrabSample_data/C224.csv")

```

## Combine CTD and Grab Sample Data for each Cruise into one tibble
For each cruise I have to make a decision on which CTD cast to use for plotting. Check oxygen profiles (above) for major features and also notes on which samples came from which casts.

**C212_2**: DNA for metagnome/ iTags came from cast 3 so use CTD data from cast 3, C212_2_3

**C212_3**: Use cast 1, which targetted samples from the chemoautotrophy zone (depths 260-320m). CTD goes down to 399m

**C216_2**: In virus paper, we used CTD data from C216_2_2 and C216_2_4 because those are where DNA/ VLP samples came from. Both casts have the full profile to 900m and both collected at 148, 200, 237, 247, 267, and 900m. Looking at DO profiles (above) they are very similar so it doesn't matter too much (unlike for C212_2). So plot C216_2_2 for now.

**C216_3**: Use cast 1, which targetted samples from the chemoautotrophy zone (depths 250-310m). CTD goes down to 399m

**C224**: Use cast 1, which targetted samples from the chemoautotrophy zone (depths 277-329m). CTD goes down to 397m


```{r}
C212_2 <- full_join(C212_2_3_ctd,C212_2_grab, by = "depth")
C212_3 <- full_join(C212_3_1_ctd,C212_3_grab, by = "depth")

C216_2 <- full_join(C216_2_2_ctd,C216_2_grab, by = "depth")
C216_3 <- full_join(C216_3_1_ctd,C216_3_grab, by = "depth")

C224 <- full_join(C224_1_ctd,C224_grab, by = "depth")
```


Next make the data "tidy" for for tidyverse format, which will make it easier to plot
```{r}
C212_2 <- drop_na(pivot_longer(C212_2, cols = colnames(C212_2)[2:dim(C212_2)[2]]))
C212_3 <- drop_na(pivot_longer(C212_3, cols = colnames(C212_3)[2:dim(C212_3)[2]]))

C216_2 <- drop_na(pivot_longer(C216_2, cols = colnames(C216_2)[2:dim(C216_2)[2]]))
C216_3 <- drop_na(pivot_longer(C216_3, cols = colnames(C216_3)[2:dim(C216_3)[2]]))

C224 <- drop_na(pivot_longer(C224, cols = colnames(C224)[2:dim(C224)[2]]))
```


## Plots
Make multi-panel profile plots for each separate cruise using cowplot and egg packages. Found [this](https://wilkelab.org/cowplot/articles/shared_legends.html) and [this](https://stackoverflow.com/questions/52060601/ggplot-multiple-legends-arrangement) helpful.

#### C212_2
```{r}
C212_2_panel1 <- ggplot() +
  geom_line(data = subset(C212_2, name %in% c("BAT")), aes(x = depth, y = value, color = "black"), size=1.5, na.rm = T) +
  geom_area(data = subset(C212_2, name %in% c("oxygen")), aes(x = depth, y = value/300, fill = "cyan")) + # use scaling factor to put oxygen and BAT on same axis- WILL CHANGE FOR EVERY PANEL
  scale_fill_manual(name = '', values = c('cyan'='cyan'), labels = c('oxygen')) +
  scale_colour_manual(name = '', values =c('black'='black', 'cyan'='cyan'), labels = c('BAT', 'oxygen')) +
  scale_y_continuous(name = expression(BAT~"["~m^{-1}~"]"),
                     sec.axis = sec_axis(trans=~.*300, name="oxygen [µM]"), expand = c(0, 0)) +
  scale_x_continuous(name = "depth [m]") +
  scale_x_reverse(expand = c(0, 0)) +
  coord_cartesian() + # insead of limits, use coord_cartesian so the shading doesn't get cutoff
  coord_flip(xlim = c(400, 100), ylim = c(0, 150/300)) + # use same scaling factor as for oxygen in geom_area above- WILL CHANGE EVERY PANEL
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(0, 10, 0, 10)) # Put a small margin on L and R for later
C212_2_panel1 <- move_layers(C212_2_panel1, "GeomArea", position = "bottom")  # move_layers from gginnards can shuffle geom layers in plot


C212_2_panel2 <- ggplot() +
  geom_line(data = subset(C212_2, name %in% c("Micro_Abund_DAPI")), aes(x = depth, y = value, color = "black"), size=1, lty = 2) +
  geom_point(data = subset(C212_2, name %in% c("Micro_Abund_DAPI")), aes(x = depth, y = value, color = "black"), shape = 21, fill = "white", size = 3) +
  geom_errorbar(data = subset(C212_2, name %in% c("Micro_Abund_DAPI")), aes(x = depth, y = value, ymin = as_vector(subset(C212_2, name %in% c("Micro_Abund_DAPI"))[,3] - subset(C212_2, name %in% c("Micro_Abund_DAPI_SD"))[,3]), ymax = as_vector(subset(C212_2, name %in% c("Micro_Abund_DAPI"))[,3] + subset(C212_2, name %in% c("Micro_Abund_DAPI_SD"))[,3]))) + # add in error bars on microscopy count data
  geom_area(data = subset(C212_2, name %in% c("oxygen")), aes(x = depth, y = value/8, fill = "cyan"), show.legend = FALSE) + # turn legend off for oxygen so it doesn't repeat when panels are together  # scaling factor CHANGE EVERY PANEL
  scale_fill_manual(name = '', values = c('cyan'='cyan'), labels = c('oxygen')) +
  scale_colour_manual(name = '', values =c('black'='black'), labels = c('Microbial Abund')) +
  scale_y_continuous(name = expression(Microbial~Abund~"["~x10^{8}~L^{-1}~"]"),
                     sec.axis = sec_axis(trans=~.*8, name="oxygen [µM]"), expand = c(0, 0)) + # reciprocal of scaling factor CHANGE EVERY PANEL
  scale_x_reverse(expand = c(0, 0)) +
  coord_cartesian() + 
  coord_flip(xlim = c(400, 100), ylim = c(0, 150/8)) + # scaling factor CHANGE EVERY PANEL
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(0, 10, 0, 10)) +
  theme(axis.text.y=element_blank(), axis.title.y=element_blank()) # turn off depth label for all panels after 1st to reduce redundancy
C212_2_panel2 <- move_layers(C212_2_panel2, "GeomArea", position = "bottom") 



C212_2_panel3 <- ggplot() +
  geom_line(data = subset(C212_2, name %in% c("NH4","NO_x")), aes(x = depth, y = value, color=name, linetype = name), size=1) +
  geom_point(data = subset(C212_2, name %in% c("NH4","NO_x")), aes(x = depth, y = value, color=name, shape = name), size = 3) +
  scale_color_manual(name = ' ', values =c("red","darkgreen"), labels = c('NH4','NOx')) +
  scale_shape_manual(name = ' ', values = c(15,17), labels = c('NH4','NOx')) +
  scale_linetype_manual(name = ' ', values = c("solid","dashed"), labels = c('NH4','NOx')) +
  geom_area(data = subset(C212_2, name %in% c("oxygen")), aes(x = depth, y = value/8, fill = "cyan"), show.legend = FALSE) + # scaling factor CHANGE EVERY PANEL
  scale_fill_manual(name = '', values = c('cyan'='cyan'), labels = c('oxygen')) +
  scale_y_continuous(name = expression(NH[4]~or~NO[x]~"[µM]"),
                     sec.axis = sec_axis(trans=~.*8, name="oxygen [µM]"), expand = c(0, 0)) + # reciprocal of scaling factor CHANGE EVERY PANEL
  scale_x_reverse(expand = c(0, 0)) +
  coord_cartesian() + 
  coord_flip(xlim = c(400, 100), ylim = c(0, 150/8)) + # scaling factor CHANGE EVERY PANEL
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(0, 10, 0, 10)) +
  theme(axis.text.y=element_blank(), axis.title.y=element_blank())
C212_2_panel3 <- move_layers(C212_2_panel3, "GeomArea", position = "bottom") 



# extract legend from plots, horizontally laid out 
legend_1 <- get_legend(C212_2_panel1 + 
                         guides(color = guide_legend(nrow = 1)) +
                         theme(legend.position = "bottom"))
legend_2 <- get_legend(C212_2_panel2 + 
                        guides(color = guide_legend(nrow = 1)) +
                         theme(legend.position = "bottom"))
legend_3 <- get_legend(C212_2_panel3 + 
                         guides(color = guide_legend(nrow = 1)) +
                         theme(legend.position = "bottom"))


# set explicit panel size so they will be consistent for all figures. Function from egg package (need to do this after extracting legend)
C212_2_panel1 <- set_panel_size(C212_2_panel1, width  = unit(3, "cm"), height = unit(6, "cm"))  
C212_2_panel2 <- set_panel_size(C212_2_panel2, width  = unit(3, "cm"), height = unit(6, "cm")) 
C212_2_panel3 <- set_panel_size(C212_2_panel3, width  = unit(3, "cm"), height = unit(6, "cm")) 


# cowplot- put together panels, without legends
panels <- plot_grid(C212_2_panel1, C212_2_panel2, C212_2_panel3, labels = "AUTO", nrow = 1, hjust = -1.5, vjust = 4.5)
panels

# put together legends
leg123 <- plot_grid(legend_1, legend_2, legend_3, nrow = 1, align = "hv")
leg123

# combine plot and legend in 2 rows
C212_2_plot <- plot_grid(panels, leg123, nrow = 2, rel_heights = c(1,.1))
C212_2_plot


save_plot("Figures/C212_2_plot.eps", C212_2_plot)
```


#### C212_3

```{r}

C212_3_panel1 <- ggplot() +
  geom_line(data = subset(C212_3, name %in% c("BAT")), aes(x = depth, y = value, color = "black"), size=1.5, na.rm = T) +
  geom_area(data = subset(C212_3, name %in% c("oxygen")), aes(x = depth, y = value/300, fill = "cyan")) + # use scaling factor to put oxygen and BAT on same axis- WILL CHANGE FOR EVERY PANEL
  geom_area(data = subset(C212_3, name %in% c("H2S")), aes(x = depth, y = value/300, fill = "red4")) + # use same scaling factor as for oxyen-CHANGE FOR EVERY PANEL
  scale_fill_manual(name = '', values = c('cyan'='cyan', 'red4'='red4'), labels = c('O2','H2S')) +
  scale_colour_manual(name = '', values =c('black'='black', 'cyan'='cyan', 'red4'='red4'), labels = c('BAT', 'oxygen','H2S')) +
  scale_y_continuous(name = expression(BAT~"["~m^{-1}~"]"),
                     sec.axis = sec_axis(trans=~.*300, name="O2 or H2S [µM]"), expand = c(0, 0)) +
  scale_x_continuous(name = "depth [m]") +
  scale_x_reverse(expand = c(0, 0)) +
  coord_cartesian() + # insead of limits, use coord_cartesian so the shading doesn't get cutoff
  coord_flip(xlim = c(400, 100), ylim = c(0, 150/300)) + # use same scaling factor as for oxygen in geom_area above- WILL CHANGE EVERY PANEL
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(0, 10, 0, 10)) # Put a small margin on L and R for later
C212_3_panel1 <- move_layers(C212_3_panel1, "GeomArea", position = "bottom")  # move_layers from gginnards can shuffle geom layers in plot



C212_3_panel2 <- ggplot() +
  geom_line(data = subset(C212_3, name %in% c("Micro_Abund_DAPI")), aes(x = depth, y = value, color = "black"), size=1, lty = 2) +
  geom_point(data = subset(C212_3, name %in% c("Micro_Abund_DAPI")), aes(x = depth, y = value, color = "black"), shape = 21, fill = "white", size = 3) +
  geom_errorbar(data = subset(C212_3, name %in% c("Micro_Abund_DAPI")), aes(x = depth, y = value, ymin = as_vector(subset(C212_3, name %in% c("Micro_Abund_DAPI"))[,3] - subset(C212_3, name %in% c("Micro_Abund_DAPI_SD"))[,3]), ymax = as_vector(subset(C212_3, name %in% c("Micro_Abund_DAPI"))[,3] + subset(C212_3, name %in% c("Micro_Abund_DAPI_SD"))[,3]))) + # add in error bars on microscopy count data
  geom_area(data = subset(C212_3, name %in% c("oxygen")), aes(x = depth, y = value/8, fill = "cyan"), show.legend = FALSE) + # turn legend off for oxygen so it doesn't repeat when panels are together  # scaling factor CHANGE EVERY PANEL
  geom_area(data = subset(C212_3, name %in% c("H2S")), aes(x = depth, y = value/8, fill = "red4"), show.legend = FALSE) + # use same scaling factor as for oxyen-CHANGE FOR EVERY PANEL
  scale_fill_manual(name = '', values = c('cyan'='cyan', 'red4'='red4'), labels = c('O2','H2S')) +
  scale_colour_manual(name = '', values =c('black'='black'), labels = c('Microbial Abund')) +
  scale_y_continuous(name = expression(Microbial~Abund~"["~x10^{8}~L^{-1}~"]"),
                     sec.axis = sec_axis(trans=~.*8, name="O2 or H2S [µM]"), expand = c(0, 0)) + # reciprocal of scaling factor CHANGE EVERY PANEL
  scale_x_reverse(expand = c(0, 0)) +
  coord_cartesian() + 
  coord_flip(xlim = c(400, 100), ylim = c(0, 150/8)) + # scaling factor CHANGE EVERY PANEL
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(0, 10, 0, 10)) +
  theme(axis.text.y=element_blank(), axis.title.y=element_blank()) # turn off depth label for all panels after 1st to reduce redundancy
C212_3_panel2 <- move_layers(C212_3_panel2, "GeomArea", position = "bottom") 


C212_3_panel3 <- ggplot() +
  geom_line(data = subset(C212_3, name %in% c("NH4","NO3")), aes(x = depth, y = value, color=name, linetype = name), size=1) +
  geom_point(data = subset(C212_3, name %in% c("NH4","NO3")), aes(x = depth, y = value, color=name, shape = name), size = 3) +
  scale_color_manual(name = ' ', values =c("red", "goldenrod4"), labels = c('NH4','NO3')) +
  scale_shape_manual(name = ' ', values = c(15,18), labels = c('NH4','NO3')) +
  scale_linetype_manual(name = ' ', values = c("solid","dotted"), labels = c('NH4','NO3')) +
  geom_area(data = subset(C212_3, name %in% c("oxygen")), aes(x = depth, y = value/8, fill = "cyan"), show.legend = FALSE) + # turn legend off for oxygen so it doesn't repeat when panels are together  # scaling factor CHANGE EVERY PANEL
  geom_area(data = subset(C212_3, name %in% c("H2S")), aes(x = depth, y = value/8, fill = "red4"), show.legend = FALSE) + # use same scaling factor as for oxyen-CHANGE FOR EVERY PANEL
  scale_fill_manual(name = '', values = c('cyan'='cyan', 'red4'='red4'), labels = c('O2','H2S')) +
  scale_y_continuous(name = "nutrients [µM]",
                     sec.axis = sec_axis(trans=~.*8, name="O2 or H2S [µM]"), expand = c(0, 0)) + # reciprocal of scaling factor CHANGE EVERY PANEL
  scale_x_reverse(expand = c(0, 0)) +
  coord_cartesian() + 
  coord_flip(xlim = c(400, 100), ylim = c(0, 150/8)) + # scaling factor CHANGE EVERY PANEL
  theme_bw() +
  theme(legend.position = "none") +
  theme(plot.margin = margin(0, 10, 0, 10)) +
  theme(axis.text.y=element_blank(), axis.title.y=element_blank())
C212_3_panel3 <- move_layers(C212_3_panel3, "GeomArea", position = "bottom") 

## STOPPED HERE- FIGURE OUT HOW TO PLOT NO2 IN ABOVE, MAYBE MULTIPLY BY 10. JAN 11 

# extract legend from plots, horizontally laid out 
legend_1 <- get_legend(C212_3_panel1 + 
                         guides(color = guide_legend(nrow = 1)) +
                         theme(legend.position = "bottom"))
legend_2 <- get_legend(C212_3_panel2 + 
                        guides(color = guide_legend(nrow = 1)) +
                         theme(legend.position = "bottom"))
legend_3 <- get_legend(C212_3_panel3 + 
                         guides(color = guide_legend(nrow = 1)) +
                         theme(legend.position = "bottom"))


# set explicit panel size so they will be consistent for all figures. Function from egg package (need to do this after extracting legend)
C212_3_panel1 <- set_panel_size(C212_3_panel1, width  = unit(3, "cm"), height = unit(6, "cm"))  
C212_3_panel2 <- set_panel_size(C212_3_panel2, width  = unit(3, "cm"), height = unit(6, "cm")) 
C212_3_panel3 <- set_panel_size(C212_3_panel3, width  = unit(3, "cm"), height = unit(6, "cm")) 


# cowplot- put together panels, without legends
panels <- plot_grid(C212_3_panel1, C212_3_panel2, C212_3_panel3, labels = "AUTO", nrow = 1, hjust = -1.5, vjust = 4.5)
panels

# put together legends
leg123 <- plot_grid(legend_1, legend_2, legend_3, nrow = 1, align = "hv")
leg123

# combine plot and legend in 2 rows
C212_3_plot <- plot_grid(panels, leg123, nrow = 2, rel_heights = c(1,.1))
C212_3_plot


save_plot("Figures/C212_3_plot.eps", C212_3_plot)
  
```



